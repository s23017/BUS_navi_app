// Firestore セキュリティルール
// これをFirebaseコンソールで設定してください

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザープロフィール関連のルール
    match /Users/{userId} {
      // ユーザー本人のみが自分のプロフィールを読み書き可能
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // 他のユーザーのプロフィールは読み取りのみ可能（認証済みユーザーのみ）
      allow read: if request.auth != null;
    }
    
    // バスライダーの位置情報関連のルール
    match /busRiderLocations/{locationId} {
      // 認証済みユーザーのみが位置情報を読み書き可能
      allow read, write: if request.auth != null;
      
      // 位置情報の作成時は、自分のuidがuserIdフィールドと一致する必要がある
      allow create: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
                   
      // 位置情報の更新時は、自分のuidがuserIdフィールドと一致する必要がある
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // バス停通過記録関連のルール
    match /busStopPassages/{passageId} {
      // 認証済みユーザーのみが通過記録を読み書き可能
      allow read, write: if request.auth != null;
      
      // 通過記録の作成時は、自分のuidがuserIdフィールドと一致する必要がある
      allow create: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
                   
      // 通過記録の更新時は、自分のuidがuserIdフィールドと一致する必要がある
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // 開発環境用の一時的なルール（本番では削除してください）
    // match /{document=**} {
    //   allow read, write: if request.auth != null;
    // }
  }
}
